/*
 * jquery.atd.js - jQuery powered writing check with After the Deadline
 * Author      : Raphael Mudge, Automattic Inc.
 * License     : LGPL or MIT License (take your pick)
 * Project     :  http://www.afterthedeadline.com/development.slp
 * Contact     : raffi@automattic.com
 *
 * Derived from: 
 *
 * jquery.spellchecker.js - a simple jQuery Spell Checker
 * Copyright (c) 2008 Richard Willis
 * MIT license  : http://www.opensource.org/licenses/mit-license.php
 * Project      : http://jquery-spellchecker.googlecode.com
 * Contact      : willis.rh@gmail.com
 */var AtD={rpc:"",rpc_css:"http://www.polishmywriting.com/atd-jquery/server/proxycss.php?data=",rpc_css_lang:"en",api_key:"",i18n:{},listener:{}};AtD.getLang=function(a,b){return AtD.i18n[a]==undefined?b:AtD.i18n[a]};AtD.addI18n=function(a){AtD.i18n=a;AtD.core.addI18n(a)};AtD.setIgnoreStrings=function(a){AtD.core.setIgnoreStrings(a)};AtD.showTypes=function(a){AtD.core.showTypes(a)};AtD.checkCrossAJAX=function(a,b){typeof AtD_proofread_click_count!="undefined"&&AtD_proofread_click_count++;AtD.callback_f=b;AtD.remove(a);var c=jQuery("#"+a),d=c.html();text=jQuery.trim(c.html());text=text.replace(/\&lt;/g,"<").replace(/\&gt;/g,">").replace(/\&amp;/g,"&");text=encodeURIComponent(text.replace(/\%/g,"%25"));if(text.length>2e3&&navigator.appName=="Microsoft Internet Explorer"||text.length>7800){b!=undefined&&b.error!=undefined&&b.error("Maximum text length for this browser exceeded");return}CSSHttpRequest.get(AtD.rpc_css+text+"&lang="+AtD.rpc_css_lang+"&nocache="+(new Date).getTime(),function(b){var c;if(navigator.appName=="Microsoft Internet Explorer"){c=new ActiveXObject("Microsoft.XMLDOM");c.async=!1;c.loadXML(b)}else c=(new DOMParser).parseFromString(b,"text/xml");if(AtD.core.hasErrorMessage(c)){AtD.callback_f!=undefined&&AtD.callback_f.error!=undefined&&AtD.callback_f.error(AtD.core.getErrorMessage(c));return}AtD.container=a;var d=AtD.processXML(a,c);AtD.callback_f!=undefined&&AtD.callback_f.ready!=undefined&&AtD.callback_f.ready(d);d==0&&AtD.callback_f!=undefined&&AtD.callback_f.success!=undefined&&AtD.callback_f.success(d);AtD.counter=d;AtD.count=d})};AtD.check=function(a,b){typeof AtD_proofread_click_count!="undefined"&&AtD_proofread_click_count++;AtD.callback_f=b;AtD.remove(a);var c=jQuery("#"+a),d=c.html();text=jQuery.trim(c.html());text=text.replace(/\&lt;/g,"<").replace(/\&gt;/g,">").replace(/\&amp;/g,"&");text=encodeURIComponent(text);jQuery.ajax({type:"POST",url:AtD.rpc+"/checkDocument",data:"key="+AtD.api_key+"&data="+text,format:"raw",dataType:jQuery.browser.msie?"text":"xml",error:function(a,b,c){AtD.callback_f!=undefined&&AtD.callback_f.error!=undefined&&AtD.callback_f.error(b+": "+c)},success:function(b){var c;if(typeof b=="string"){c=new ActiveXObject("Microsoft.XMLDOM");c.async=!1;c.loadXML(b)}else c=b;if(AtD.core.hasErrorMessage(c)){AtD.callback_f!=undefined&&AtD.callback_f.error!=undefined&&AtD.callback_f.error(AtD.core.getErrorMessage(c));return}AtD.container=a;var d=AtD.processXML(a,c);AtD.callback_f!=undefined&&AtD.callback_f.ready!=undefined&&AtD.callback_f.ready(d);d==0&&AtD.callback_f!=undefined&&AtD.callback_f.success!=undefined&&AtD.callback_f.success(d);AtD.counter=d;AtD.count=d}})};AtD.remove=function(a){AtD._removeWords(a,null)};AtD.clickListener=function(a){AtD.core.isMarkedNode(a.target)&&AtD.suggest(a.target)};AtD.processXML=function(a,b){var c=AtD.core.processXML(b);c.count>0&&(c.count=AtD.core.markMyWords(jQuery("#"+a).contents(),c.errors));jQuery("#"+a).unbind("click",AtD.clickListener);jQuery("#"+a).click(AtD.clickListener);return c.count};AtD.useSuggestion=function(a){this.core.applySuggestion(AtD.errorElement,a);AtD.counter--;AtD.counter==0&&AtD.callback_f!=undefined&&AtD.callback_f.success!=undefined&&AtD.callback_f.success(AtD.count)};AtD.editSelection=function(){var a=AtD.errorElement.parent();AtD.callback_f!=undefined&&AtD.callback_f.editSelection!=undefined&&AtD.callback_f.editSelection(AtD.errorElement);if(AtD.errorElement.parent()!=a){AtD.counter--;AtD.counter==0&&AtD.callback_f!=undefined&&AtD.callback_f.success!=undefined&&AtD.callback_f.success(AtD.count)}};AtD.ignoreSuggestion=function(){AtD.core.removeParent(AtD.errorElement);AtD.counter--;AtD.counter==0&&AtD.callback_f!=undefined&&AtD.callback_f.success!=undefined&&AtD.callback_f.success(AtD.count)};AtD.ignoreAll=function(a){var b=AtD.errorElement.text(),c=AtD._removeWords(a,b);AtD.counter-=c;AtD.counter==0&&AtD.callback_f!=undefined&&AtD.callback_f.success!=undefined&&AtD.callback_f.success(AtD.count);if(AtD.callback_f!=undefined&&AtD.callback_f.ignore!=undefined){AtD.callback_f.ignore(b);AtD.core.setIgnoreStrings(b)}};AtD.explainError=function(){AtD.callback_f!=undefined&&AtD.callback_f.explain!=undefined&&AtD.callback_f.explain(AtD.explainURL)};AtD.suggest=function(a){if(jQuery("#suggestmenu").length==0){var b=jQuery('<div id="suggestmenu"></div>');b.prependTo("body")}else{var b=jQuery("#suggestmenu");b.hide()}errorDescription=AtD.core.findSuggestion(a);AtD.errorElement=jQuery(a);b.empty();if(errorDescription==undefined)b.append("<strong>"+AtD.getLang("menu_title_no_suggestions","No suggestions")+"</strong>");else if(errorDescription["suggestions"].length==0)b.append("<strong>"+errorDescription.description+"</strong>");else{b.append("<strong>"+errorDescription.description+"</strong>");for(var c=0;c<errorDescription.suggestions.length;c++)(function(a){b.append("<a href=\"javascript:AtD.useSuggestion('"+a.replace(/'/,"\\'")+"')\">"+a+"</a>")})(errorDescription.suggestions[c])}if(AtD.callback_f!=undefined&&AtD.callback_f.explain!=undefined&&errorDescription["moreinfo"]!=undefined){b.append('<a href="javascript:AtD.explainError()" class="spell_sep_top">'+AtD.getLang("menu_option_explain","Explain...")+"</a>");AtD.explainURL=errorDescription.moreinfo}b.append('<a href="javascript:AtD.ignoreSuggestion()" class="spell_sep_top">'+AtD.getLang("menu_option_ignore_once","Ignore suggestion")+"</a>");if(AtD.callback_f!=undefined&&AtD.callback_f.editSelection!=undefined){AtD.callback_f!=undefined&&AtD.callback_f.ignore!=undefined?b.append("<a href=\"javascript:AtD.ignoreAll('"+AtD.container+"')\">"+AtD.getLang("menu_option_ignore_always","Ignore always")+"</a>"):b.append("<a href=\"javascript:AtD.ignoreAll('"+AtD.container+"')\">"+AtD.getLang("menu_option_ignore_all","Ignore all")+"</a>");b.append("<a href=\"javascript:AtD.editSelection('"+AtD.container+'\')" class="spell_sep_bottom spell_sep_top">'+AtD.getLang("menu_option_edit_selection","Edit Selection...")+"</a>")}else AtD.callback_f!=undefined&&AtD.callback_f.ignore!=undefined?b.append("<a href=\"javascript:AtD.ignoreAll('"+AtD.container+'\')" class="spell_sep_bottom">'+AtD.getLang("menu_option_ignore_always","Ignore always")+"</a>"):b.append("<a href=\"javascript:AtD.ignoreAll('"+AtD.container+'\')" class="spell_sep_bottom">'+AtD.getLang("menu_option_ignore_all","Ignore all")+"</a>");var d=jQuery(a).offset(),e=jQuery(a).width();e>100&&(e=50);jQuery(b).css({left:d.left+e+"px",top:d.top+"px"});jQuery(b).fadeIn(200);AtD.suggestShow=!0;setTimeout(function(){jQuery("body").bind("click",function(){AtD.suggestShow||jQuery("#suggestmenu").fadeOut(200)})},1);setTimeout(function(){AtD.suggestShow=!1},2)};AtD._removeWords=function(a,b){return this.core.removeWords(jQuery("#"+a),b)};AtD.initCoreModule=function(){var a=new AtDCore;a.hasClass=function(a,b){return jQuery(a).hasClass(b)};a.map=jQuery.map;a.contents=function(a){return jQuery(a).contents()};a.replaceWith=function(a,b){return jQuery(a).replaceWith(b)};a.findSpans=function(a){return jQuery.makeArray(a.find("span"))};a.create=function(b,c){b=b.replace(/\&/g,"&amp;");b=b.replace(/\</g,"&lt;").replace(/\>/g,"&gt;");var d=b.match(/\&lt;span class="hidden\w+?" pre="[^"]*"\&gt;.*?\&lt;\/span\&gt;/g);if(d)for(var e=0;e<d.length;e++)b=b.replace(d[e],d[e].replace(/\&lt;/gi,"<").replace(/\&gt;/gi,">"));if(a.isIE()){d=b.match(/\&lt;span class="mceItemHidden"\&gt;\&amp;nbsp;\&lt;\/span&gt;/g,b);if(d)for(var e=0;e<d.length;e++)b=b.replace(d[e],d[e].replace(/\&lt;/gi,"<").replace(/\&gt;/gi,">").replace(/\&amp;/gi,"&"))}node=jQuery('<span class="mceItemHidden"></span>');node.html(b);return node};a.remove=function(a){return jQuery(a).remove()};a.removeParent=function(a){return jQuery(a).unwrap?jQuery(a).contents().unwrap():jQuery(a).replaceWith(jQuery(a).html())};a.getAttrib=function(a,b){return jQuery(a).attr(b)};return a};AtD.core=AtD.initCoreModule();