/*
 * TinyMCE Writing Improvement Tool Plugin 
 * Author: Raphael Mudge (raffi@automattic.com)
 *
 * http://www.afterthedeadline.com
 *
 * Distributed under the LGPL
 *
 * Derived from:
 *    $Id: editor_plugin_src.js 425 2007-11-21 15:17:39Z spocke $
 *
 *    @author Moxiecode
 *    @copyright Copyright (C) 2004-2008, Moxiecode Systems AB, All rights reserved.
 *
 *    Moxiecode Spell Checker plugin released under the LGPL with TinyMCE
 */(function(){var a=tinymce.util.JSONRequest,b=tinymce.each,c=tinymce.DOM;tinymce.create("tinymce.plugins.AfterTheDeadlinePlugin",{getInfo:function(){return},initAtDCore:function(a,c){var d=new AtDCore;d.map=b;d.getAttrib=function(b,c){return a.dom.getAttrib(b,c)};d.findSpans=function(b){return b==undefined?a.dom.select("span"):a.dom.select("span",b)};d.hasClass=function(b,c){return a.dom.hasClass(b,c)};d.contents=function(a){return a.childNodes};d.replaceWith=function(b,c){return a.dom.replace(c,b)};d.create=function(b){return a.dom.create("span",{"class":"mceItemHidden"},b)};d.removeParent=function(b){a.dom.remove(b,1);return b};d.remove=function(b){a.dom.remove(b)};d.getLang=function(b,c){return a.getLang("AtD."+b,c)};d.setIgnoreStrings(a.getParam("atd_ignore_strings",[]).join(","));d.showTypes(a.getParam("atd_show_types",""));return d},init:function(a,c){if(typeof AtDCore=="undefined")return;var d=this,e=this,f=a,g=this.initAtDCore(f,e);this.url=c;this.editor=a;a.core=g;var h=tinymce.util.Cookie.getHash("atd_ignore");h==undefined&&(h={});f.addCommand("mceWritingImprovementTool",function(b){typeof AtD_proofread_click_count!="undefined"&&AtD_proofread_click_count++;e.editor.setProgressState(1);e._removeWords();e.sendRequest("checkDocument",a.getContent({format:"raw"}),function(c,d,f){e.editor.setProgressState(0);if(d.status!=200||d.responseText.substr(1,4)=="html"||!d.responseXML){a.windowManager.alert(e.editor.getLang("AtD.message_server_error","There was a problem communicating with the Proofreading service. Try again in one minute."),b?function(){b(0)}:function(){});return}if(d.responseXML.getElementsByTagName("message").item(0)!=null){a.windowManager.alert(d.responseXML.getElementsByTagName("message").item(0).firstChild.data,b?function(){b(0)}:function(){});return}var h=g.processXML(d.responseXML),i=0;if(h.count>0){i=e.markMyWords(h.errors);a.suggestions=h.suggestions}i!=0||!!b&&b!=undefined?b&&b(i):a.windowManager.alert(e.editor.getLang("AtD.message_no_errors_found","No writing errors were found."))})});f.onInit.add(function(){f.settings.content_css!==!1&&f.dom.loadCSS(f.getParam("atd_css_url",c+"/css/content.css"))});f.onClick.add(e._showMenu,e);f.onContextMenu.add(e._showMenu,e);f.onPreProcess.add(function(a,c){var d=a.dom;b(d.select("span",c.node).reverse(),function(a){a&&(d.hasClass(a,"hiddenGrammarError")||d.hasClass(a,"hiddenSpellError")||d.hasClass(a,"hiddenSuggestion")||d.hasClass(a,"mceItemHidden")||d.getAttrib(a,"class")==""&&d.getAttrib(a,"style")==""&&d.getAttrib(a,"id")==""&&!d.hasClass(a,"Apple-style-span")&&d.getAttrib(a,"mce_name")=="")&&d.remove(a,1)})});f.onBeforeExecCommand.add(function(a,b){b=="mceCodeEditor"?e._removeWords():b=="mceFullScreen"&&e._done()});a.addButton("AtD",{title:a.getLang("AtD.button_proofread_tooltip","Proofread Writing"),image:a.getParam("atd_button_url",c+"/atdbuttontr.gif"),cmd:"mceWritingImprovementTool"})},_removeWords:function(a){var b=this.editor,c=b.dom,d=b.selection,e=d.getBookmark();b.core.removeWords(undefined,a);c.setHTML(c.getRoot(),c.getRoot().innerHTML);d.moveToBookmark(e)},markMyWords:function(a){var b=this.editor,c=b.selection,d=c.getBookmark(),e=b.core.markMyWords(b.core.contents(this.editor.getBody()),a);c.moveToBookmark(d);return e},_showMenu:function(a,b){var d=this,a=d.editor,e=d._menu,f,g=a.dom,h=g.getViewPort(a.getWin()),i=this;if(!e){f=c.getPos(a.getContentAreaContainer());e=a.controlManager.createDropMenu("spellcheckermenu",{offset_x:f.x,offset_y:f.y,"class":"mceNoIcons"});d._menu=e}if(a.core.isMarkedNode(b.target)){e.removeAll();var j=a.core.findSuggestion(b.target);if(j==undefined)e.add({title:i.editor.getLang("AtD.menu_title_no_suggestions","No suggestions"),"class":"mceMenuItemTitle"}).setDisabled(1);else if(j["suggestions"].length==0)e.add({title:j.description,"class":"mceMenuItemTitle"}).setDisabled(1);else{e.add({title:j.description,"class":"mceMenuItemTitle"}).setDisabled(1);for(var k=0;k<j.suggestions.length;k++)(function(c){e.add({title:c,onclick:function(){a.core.applySuggestion(b.target,c);d._checkDone()}})})(j.suggestions[k]);e.addSeparator()}if(j!=undefined&&j["moreinfo"]!=null){(function(b){e.add({title:i.editor.getLang("AtD.menu_option_explain","Explain..."),onclick:function(){a.windowManager.open({url:b,width:480,height:380,inline:!0},{theme_url:this.url})}})})(j.moreinfo);e.addSeparator()}e.add({title:i.editor.getLang("AtD.menu_option_ignore_once","Ignore suggestion"),onclick:function(){g.remove(b.target,1);d._checkDone()}});String(this.editor.getParam("atd_ignore_enable","false"))=="true"?e.add({title:i.editor.getLang("AtD.menu_option_ignore_always","Ignore always"),onclick:function(){var a=d.editor.getParam("atd_ignore_rpc_url","{backend}");if(a=="{backend}"){var c=tinymce.util.Cookie.getHash("atd_ignore");c==undefined&&(c={});c[b.target.innerHTML]=1;tinymce.util.Cookie.setHash("atd_ignore",c,new Date((new Date).getTime()+15768e7))}else{var e=d.editor.getParam("atd_rpc_id","12345678");tinymce.util.XHR.send({url:a+encodeURI(b.target.innerHTML).replace(/&/g,"%26")+"&key="+e,content_type:"text/xml",async:!0,type:"GET",success:function(a,b,c){},error:function(a,b,c){alert("Ignore preference save failed\n"+a+"\n"+b.status+"\nAt: "+c.url)}});d.editor.core.setIgnoreStrings(b.target.innerHTML)}d._removeWords(b.target.innerHTML);d._checkDone()}}):e.add({title:i.editor.getLang("menu_option_ignore_all","Ignore all"),onclick:function(){d._removeWords(b.target.innerHTML);d._checkDone()}});a.selection.select(b.target);f=g.getPos(b.target);e.showMenu(f.x,f.y+b.target.offsetHeight-h.y);return tinymce.dom.Event.cancel(b)}e.hideMenu()},_checkDone:function(){var a=this,c=a.editor,d=c.dom,e;b(d.select("span"),function(a){if(a&&d.hasClass(a,"mceItemHidden")){e=!0;return!1}});e||a._done()},_done:function(){var a=this;a._removeWords();a._menu&&a._menu.hideMenu();a.editor.nodeChanged()},sendRequest:function(a,b,c){var d=this.editor.getParam("atd_rpc_id","12345678"),e=this.editor.getParam("atd_rpc_url","{backend}"),f=this;if(e=="{backend}"||d=="12345678"){this.editor.setProgressState(0);alert("Please specify: atd_rpc_url and atd_rpc_id");return}tinymce.util.XHR.send({url:e+"/"+a,content_type:"text/xml",type:"POST",data:"data="+encodeURI(b).replace(/&/g,"%26")+"&key="+d,async:!0,success:c,error:function(a,b,c){f.editor.setProgressState(0);alert(a+"\n"+b.status+"\nAt: "+c.url)}})}});tinymce.PluginManager.add("AtD",tinymce.plugins.AfterTheDeadlinePlugin)})();